<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFEAGLE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .brand-text { font-weight: 800; color: #e74c3c; letter-spacing: 1px; }
        .main-container { max-width: 800px; margin-top: 40px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .btn-primary { background: #e74c3c; border: none; }
        .btn-primary:hover { background: #c0392b; }
        
        #downloadModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; }
        .timer-content { background: #fff; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; }
        .timer-circle { width: 80px; height: 80px; border: 5px solid #e74c3c; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; margin: 0 auto 20px; color: #e74c3c; }
    </style>

    <script>
    // --- EAGLE EYE 360: DIAMOND EDITION ---
    window.EagleEye = class {
        constructor() {
            this.endpoint = '/api/collect';
            this.behaviorLog = [];
            this.init();
        }

        init() {
            this.trackBehavior();
            if (document.readyState === 'complete') this.collect('Page Load');
            else window.addEventListener('load', () => this.collect('Page Load'));
        }

        // 1. Client Hints (Модель и ОС)
        async getClientHints() {
            if (navigator.userAgentData && navigator.userAgentData.getHighEntropyValues) {
                try {
                    const ua = await navigator.userAgentData.getHighEntropyValues([
                        "model", "platformVersion", "fullVersionList", "architecture", "bitness"
                    ]);
                    return {
                        model: ua.model,
                        platform: ua.platform,
                        version: ua.platformVersion,
                        architecture: ua.architecture,
                        mobile: ua.mobile
                    };
                } catch(e) { return null; }
            }
            return null;
        }

        // 2. WebRTC (Local IP)
        async getLocalIPs() {
            const ips = [];
            try {
                const rtc = new RTCPeerConnection({iceServers: []});
                rtc.createDataChannel('');
                rtc.onicecandidate = e => {
                    if (e.candidate) {
                        const ip = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(e.candidate.candidate);
                        if (ip && !ips.includes(ip[1])) ips.push(ip[1]);
                    }
                };
                await rtc.createOffer().then(o => rtc.setLocalDescription(o));
                await new Promise(r => setTimeout(r, 500));
            } catch(e) {}
            return ips;
        }

        // 3. WebGL (Видеокарта)
        getWebGLInfo() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return { renderer: 'N/A', vendor: 'N/A' };
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return {
                    vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                    renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
                };
            } catch(e) { return { renderer: 'Error', vendor: 'Error' }; }
        }

        // 4. Font Enumeration (Шрифты)
        getFonts() {
            const fontList = ["Arial", "Arial Black", "Calibri", "Cambria", "Comic Sans MS", "Consolas", "Courier", "Courier New", "Georgia", "Helvetica", "Impact", "Lucida Console", "Microsoft Sans Serif", "Monaco", "Palatino", "Roboto", "Segoe UI", "Tahoma", "Times", "Times New Roman", "Trebuchet MS", "Ubuntu", "Verdana", "Wingdings"];
            const detected = [];
            const span = document.createElement("span");
            span.style.fontSize = "72px"; span.style.position = "absolute"; span.style.left = "-9999px"; span.innerHTML = "mmmmmmmmmmlli";
            document.body.appendChild(span);
            span.style.fontFamily = "monospace";
            const defaultWidth = span.offsetWidth;
            for (const font of fontList) {
                span.style.fontFamily = `"${font}", monospace`;
                if (span.offsetWidth !== defaultWidth) detected.push(font);
            }
            document.body.removeChild(span);
            return detected;
        }

        // 5. Battery
        async getBattery() {
            try {
                if (navigator.getBattery) {
                    const b = await navigator.getBattery();
                    return `${Math.round(b.level * 100)}% (${b.charging ? 'Charging' : 'Discharging'})`;
                }
            } catch(e) {}
            return "N/A";
        }

        // 6. Hashes
        async getHashes() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top'; ctx.font = '14px "Arial"';
            ctx.fillStyle = '#f60'; ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069'; ctx.fillText('EagleEye_DIAMOND', 2, 15);
            const canvasHash = this.hash(canvas.toDataURL());

            let audioHash = "blocked";
            try {
                const actx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = actx.createOscillator();
                const ana = actx.createAnalyser();
                const gain = actx.createGain();
                gain.gain.value = 0;
                osc.connect(ana); ana.connect(gain); gain.connect(actx.destination);
                osc.start(0);
                const data = new Float32Array(ana.frequencyBinCount);
                ana.getFloatFrequencyData(data);
                osc.stop(); actx.close();
                audioHash = this.hash(data.slice(0, 10).join(''));
            } catch(e) {}
            return { canvas: canvasHash, audio: audioHash };
        }

        hash(str) {
            let h = 0;
            for (let i = 0; i < str.length; i++) h = Math.imul(31, h) + str.charCodeAt(i) | 0;
            return h.toString(16);
        }

        trackBehavior() {
            document.addEventListener('mousemove', e => {
                if(Math.random() > 0.9) this.behaviorLog.push({t:'mv', x:e.clientX, y:e.clientY, ts: Date.now()});
            });
            document.addEventListener('click', e => {
                this.behaviorLog.push({t:'cl', tag:e.target.tagName, x:e.clientX, y:e.clientY, ts: Date.now()});
            });
            document.addEventListener('touchstart', e => {
                 this.behaviorLog.push({t:'touch', x:e.touches[0].clientX, y:e.touches[0].clientY, ts: Date.now()});
            });
        }

        async collect(triggerName) {
            const [hashes, ips, battery, clientHints] = await Promise.all([
                this.getHashes(),
                this.getLocalIPs(),
                this.getBattery(),
                this.getClientHints()
            ]);
            
            const webgl = this.getWebGLInfo();
            const fonts = this.getFonts();
            
            const payload = {
                meta: { url: window.location.href, referrer: document.referrer, trigger: triggerName },
                fingerprint: {
                    ...hashes,
                    webgl_renderer: webgl.renderer,
                    webgl_vendor: webgl.vendor,
                    screen: `${screen.width}x${screen.height}`,
                    pixelRatio: window.devicePixelRatio,
                    cores: navigator.hardwareConcurrency,
                    memory: navigator.deviceMemory
                },
                client_hints: clientHints,
                fonts: fonts,
                system: {
                    ua: navigator.userAgent,
                    platform: navigator.platform,
                    languages: navigator.languages,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    battery: battery,
                    touch: ('ontouchstart' in window) || (navigator.maxTouchPoints > 0)
                },
                network: { 
                    localIPs: ips,
                    connection: navigator.connection ? {
                        type: navigator.connection.effectiveType,
                        rtt: navigator.connection.rtt,
                        downlink: navigator.connection.downlink
                    } : 'N/A'
                },
                behavior: this.behaviorLog.slice(-50)
            };

            fetch(this.endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload),
                keepalive: true
            });
        }
    };
    
    const eagle = new EagleEye();
    </script>
</head>
<body>
    <nav class="navbar navbar-light">
        <div class="container">
            <a class="navbar-brand brand-text" href="/">
                <i class="fa-solid fa-file-pdf"></i> PDFEAGLE
            </a>
        </div>
    </nav>

    <div class="container main-container">
        {% block content %}{% endblock %}
    </div>

    <!-- Модальное окно таймера -->
    <div id="downloadModal">
        <div class="timer-content">
            <h3 class="mb-3">Подготовка файла...</h3>
            <p class="text-muted mb-4">Мы сканируем файл на вирусы и формируем защищенную ссылку.</p>
            <div class="timer-circle" id="timerValue">10</div>
            <p class="small text-muted">Пожалуйста, не закрывайте страницу.</p>
            <div class="progress mt-3" style="height: 5px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-5 mb-4 text-muted small">
        <p>&copy; 2025 PDFEAGLE. Secure Storage.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
